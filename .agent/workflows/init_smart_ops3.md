---
description: Initialize Smart Ops for this repository with automatic OS detection
---
# Workflow: Initialize Smart Ops

This workflow automatically detects your operating system and generates the appropriate automation script(s).

## Usage
User: "Use /init_smart_ops"

## Agent Steps

### 1. Detect Operating System

**Agent should ask user:** "What's your primary shell environment?"

**OR auto-detect with these commands:**

#### Method 1: PowerShell Detection (Recommended - works everywhere)
```powershell
# Run this in PowerShell
if ($IsWindows -or $env:OS -match "Windows") { 
    Write-Host "Windows" 
} elseif ($IsMacOS) { 
    Write-Host "macOS" 
} elseif ($IsLinux) { 
    Write-Host "Linux" 
} else { 
    Write-Host "Unknown" 
}
```

#### Method 2: Simple OS Check
```powershell
# Even simpler - just check if on Windows
if ($env:OS -match "Windows") { "Windows" } else { "Unix" }
```

#### Method 3: Bash Detection (if in Git Bash/WSL)
```bash
uname -s
```

**Decision Matrix:**
| Detection Result | Generate Scripts |
|------------------|------------------|
| Windows (PowerShell) | `.ps1` + `.sh` (both) |
| macOS/Darwin | `.sh` only |
| Linux | `.sh` only |
| Git Bash/WSL | `.sh` only |
| Unknown/Error | `.ps1` + `.sh` (both, be safe) |

**Pro Tip:** When in doubt, generate BOTH scripts and let the user choose!

---

### 2. Detect Repository Context
```bash
gh repo view --json owner,name,url
```

Extract:
- `owner` ‚Üí {{OWNER}}
- `name` ‚Üí {{REPO}}

---

### 3. Fetch Project Board IDs (Optional)

**Ask user first:** "Do you want to enable GitHub Projects integration? (y/N)"

**If YES:**

```bash
# List projects
gh project list --owner {{OWNER}} --format json
```

**User provides PROJECT_NUMBER, then:**

```bash
# Get field details
gh project field-list {{PROJECT_NUMBER}} --owner {{OWNER}} --format json
```

**Parse the JSON to find:**
- `STATUS` field ‚Üí Get `id` and option IDs for:
  - "Todo" / "To Do" ‚Üí TODO_OPTION_ID
  - "In Progress" ‚Üí IN_PROGRESS_OPTION_ID  
  - "Done" ‚Üí DONE_OPTION_ID
- Date field named "Start Date" or "Started" ‚Üí START_DATE_FIELD_ID
- Date field named "Target Date" or "Due Date" ‚Üí TARGET_DATE_FIELD_ID

**If NO (skip projects):**
Leave all PROJECT_* and FIELD_* values as empty strings `""`

---

### 4. Generate Scripts Based on OS

**Default (safest): Generate BOTH scripts** unless you're certain it's pure Unix.

#### Scenario A: Unix-only (macOS, Linux, confirmed)
Generate: `scripts/smart-ops.sh` only

#### Scenario B: Windows or Mixed Environment  
Generate BOTH:
- `scripts/smart-ops.sh` (for Git Bash/WSL)
- `scripts/smart-ops.ps1` (for PowerShell)

Tell user: 
```
‚úÖ Created both scripts for maximum compatibility:
   - Use smart-ops.ps1 in PowerShell
   - Use smart-ops.sh in Git Bash/WSL
```

---

### 5. Script Templates

Replace these placeholders with actual values from steps 2-3:
- `{{OWNER}}` ‚Üí Repository owner
- `{{REPO}}` ‚Üí Repository name  
- `{{PROJECT_NUMBER}}` ‚Üí Project number (or `""`)
- `{{PROJECT_ID}}` ‚Üí Project ID (or `""`)
- `{{STATUS_FIELD_ID}}` ‚Üí Status field ID (or `""`)
- `{{TODO_OPTION_ID}}` ‚Üí Todo option ID (or `""`)
- `{{IN_PROGRESS_OPTION_ID}}` ‚Üí In Progress option ID (or `""`)
- `{{DONE_OPTION_ID}}` ‚Üí Done option ID (or `""`)
- `{{START_DATE_FIELD_ID}}` ‚Üí Start date field ID (or `""`)
- `{{TARGET_DATE_FIELD_ID}}` ‚Üí Target date field ID (or `""`)

---

## üìÑ Template: smart-ops.sh (Bash)

**Location:** `scripts/smart-ops.sh`

```bash
#!/bin/bash
# Smart Ops - GitHub Automation Script
# Generated by /init_smart_ops workflow

set -e

# ============ CONFIGURATION ============
REPO_OWNER="{{OWNER}}"
REPO_NAME="{{REPO}}"
REPO="${REPO_OWNER}/${REPO_NAME}"

PROJECT_NUMBER="{{PROJECT_NUMBER}}"
PROJECT_ID="{{PROJECT_ID}}"
STATUS_FIELD_ID="{{STATUS_FIELD_ID}}"
TODO_OPTION_ID="{{TODO_OPTION_ID}}"
IN_PROGRESS_OPTION_ID="{{IN_PROGRESS_OPTION_ID}}"
DONE_OPTION_ID="{{DONE_OPTION_ID}}"

START_DATE_FIELD_ID="{{START_DATE_FIELD_ID}}"
TARGET_DATE_FIELD_ID="{{TARGET_DATE_FIELD_ID}}"

DEBUG="${DEBUG:-0}"

# ============ PREREQUISITES ============

check_prerequisites() {
    local errors=0
    
    if ! command -v gh &> /dev/null; then
        echo "‚ùå GitHub CLI not installed: https://cli.github.com" >&2
        errors=$((errors + 1))
    fi
    
    if ! gh auth status &> /dev/null; then
        echo "‚ùå Not authenticated. Run: gh auth login" >&2
        errors=$((errors + 1))
    fi
    
    if [ -z "$REPO_OWNER" ] || [ -z "$REPO_NAME" ]; then
        echo "‚ùå REPO_OWNER and REPO_NAME must be set" >&2
        errors=$((errors + 1))
    fi
    
    [ "$errors" -gt 0 ] && exit 1
}

# ============ HELPERS ============

log_debug() { [ "$DEBUG" = "1" ] && echo "[DEBUG] $*" >&2; }
log_error() { echo "‚ùå $*" >&2; }
log_success() { echo "‚úÖ $*"; }

get_today() { date +%Y-%m-%d; }

get_future_date() {
    local days="${1:-7}"
    if [[ "$OSTYPE" == "darwin"* ]]; then
        date -v+${days}d +%Y-%m-%d
    else
        date -d "+${days} days" +%Y-%m-%d
    fi
}

gh_safe() {
    log_debug "gh $*"
    if output=$(gh "$@" 2>&1); then
        echo "$output"
        return 0
    else
        log_error "Command failed: gh $*"
        return 1
    fi
}

# ============ COMMANDS ============

start() {
    echo "üîç Scanning active work..."
    echo ""
    gh_safe issue list --repo "$REPO" --state open --json number,title,labels --limit 20 || return 1
    
    if [ -n "$PROJECT_NUMBER" ]; then
        echo ""
        gh project item-list "$PROJECT_NUMBER" --owner "$REPO_OWNER" --format json --limit 20 2>/dev/null || true
    fi
}

complete() {
    echo "üìã Issues ready for completion..."
    gh_safe issue list --repo "$REPO" --state open --json number,title --limit 20 || return 1
    echo ""
    echo "Today: $(get_today)"
    echo "Close with: ./smart-ops.sh close <number>"
}

create_issue() {
    local title="$1"
    local body="$2"
    local labels="${3:-enhancement}"
    local days="${4:-7}"
    
    [ -z "$title" ] && { log_error "Title required"; return 1; }
    
    echo "üìù Creating: $title (${days}d)"
    
    local url
    url=$(gh_safe issue create --repo "$REPO" --title "$title" --body "$body" --label "$labels") || return 1
    
    local num
    num=$(echo "$url" | grep -oE '[0-9]+$')
    [ -z "$num" ] && { log_error "Failed to parse issue number"; return 1; }
    
    log_success "Created #$num"
    
    if [ -n "$PROJECT_ID" ]; then
        local item_id
        item_id=$(gh_safe project item-add "$PROJECT_NUMBER" --owner "$REPO_OWNER" --url "$url" --jq '.id') || {
            log_error "Failed to add to project"
            echo "$url"
            return 0
        }
        
        [ -n "$START_DATE_FIELD_ID" ] && \
            gh project item-edit --id "$item_id" --project-id "$PROJECT_ID" \
                --field-id "$START_DATE_FIELD_ID" --date "$(get_today)" 2>/dev/null || true
        
        [ -n "$TARGET_DATE_FIELD_ID" ] && \
            gh project item-edit --id "$item_id" --project-id "$PROJECT_ID" \
                --field-id "$TARGET_DATE_FIELD_ID" --date "$(get_future_date "$days")" 2>/dev/null || true
        
        log_success "Added to project"
    fi
    
    echo "$url"
}

close_issue() {
    local num="$1"
    local comment="${2:-Completed on $(get_today)}"
    
    [ -z "$num" ] && { log_error "Issue number required"; return 1; }
    
    read -p "Close #$num? (y/N): " -n 1 -r; echo
    [[ ! $REPLY =~ ^[Yy]$ ]] && return 0
    
    gh_safe issue close "$num" --repo "$REPO" --comment "$comment" || return 1
    log_success "Closed #$num"
}

move_to_in_progress() {
    local id="$1"
    [ -z "$PROJECT_ID" ] && { log_error "No project configured"; return 1; }
    [ -z "$id" ] && { log_error "Item ID required"; return 1; }
    
    gh project item-edit --id "$id" --field-id "$STATUS_FIELD_ID" \
        --project-id "$PROJECT_ID" --single-select-option-id "$IN_PROGRESS_OPTION_ID" || return 1
    
    [ -n "$START_DATE_FIELD_ID" ] && \
        gh project item-edit --id "$id" --project-id "$PROJECT_ID" \
            --field-id "$START_DATE_FIELD_ID" --date "$(get_today)" 2>/dev/null || true
    
    log_success "‚Üí In Progress"
}

move_to_done() {
    local id="$1"
    [ -z "$PROJECT_ID" ] && { log_error "No project configured"; return 1; }
    [ -z "$id" ] && { log_error "Item ID required"; return 1; }
    
    gh project item-edit --id "$id" --field-id "$STATUS_FIELD_ID" \
        --project-id "$PROJECT_ID" --single-select-option-id "$DONE_OPTION_ID" || return 1
    
    log_success "‚Üí Done"
}

show_help() {
    cat << 'EOF'
Smart Ops - GitHub Automation

Usage: ./smart-ops.sh <command> [args]

Commands:
  start                      List open issues
  complete                   List for completion
  create <title> [body] [labels] [days]
  close <number> [comment]
  progress <item_id>         Move to In Progress
  done <item_id>             Move to Done

Examples:
  ./smart-ops.sh create "Fix bug" "Description" "bug" 3
  ./smart-ops.sh close 42 "Fixed"
  DEBUG=1 ./smart-ops.sh start
EOF
}

# ============ MAIN ============

check_prerequisites

case "${1:-help}" in
    start) start ;;
    complete) complete ;;
    create) create_issue "$2" "$3" "$4" "$5" ;;
    close) close_issue "$2" "$3" ;;
    progress) move_to_in_progress "$2" ;;
    done) move_to_done "$2" ;;
    *) show_help ;;
esac
```

**After creating, make executable:**
```bash
chmod +x scripts/smart-ops.sh
```

---

## üìÑ Template: smart-ops.ps1 (PowerShell)

**Location:** `scripts/smart-ops.ps1`

```powershell
# Smart Ops - GitHub Automation Script (PowerShell)
# Generated by /init_smart_ops workflow

$ErrorActionPreference = "Stop"

# ============ CONFIGURATION ============
$REPO_OWNER = "{{OWNER}}"
$REPO_NAME = "{{REPO}}"
$REPO = "$REPO_OWNER/$REPO_NAME"

$PROJECT_NUMBER = "{{PROJECT_NUMBER}}"
$PROJECT_ID = "{{PROJECT_ID}}"
$STATUS_FIELD_ID = "{{STATUS_FIELD_ID}}"
$TODO_OPTION_ID = "{{TODO_OPTION_ID}}"
$IN_PROGRESS_OPTION_ID = "{{IN_PROGRESS_OPTION_ID}}"
$DONE_OPTION_ID = "{{DONE_OPTION_ID}}"

$START_DATE_FIELD_ID = "{{START_DATE_FIELD_ID}}"
$TARGET_DATE_FIELD_ID = "{{TARGET_DATE_FIELD_ID}}"

$DEBUG = $env:DEBUG -eq "1"

# ============ PREREQUISITES ============

function Test-Prerequisites {
    $errors = 0
    
    try { $null = Get-Command gh -ErrorAction Stop }
    catch {
        Write-Host "X GitHub CLI not installed: https://cli.github.com" -ForegroundColor Red
        $errors++
    }
    
    try {
        $null = gh auth status 2>&1
        if ($LASTEXITCODE -ne 0) { throw }
    } catch {
        Write-Host "X Not authenticated. Run: gh auth login" -ForegroundColor Red
        $errors++
    }
    
    if ([string]::IsNullOrWhiteSpace($REPO_OWNER) -or [string]::IsNullOrWhiteSpace($REPO_NAME)) {
        Write-Host "X REPO_OWNER and REPO_NAME must be set" -ForegroundColor Red
        $errors++
    }
    
    if ($errors -gt 0) { exit 1 }
}

# ============ HELPERS ============

function Write-Debug { param([string]$Msg) if ($DEBUG) { Write-Host "[DEBUG] $Msg" -ForegroundColor Gray } }
function Write-Err { param([string]$Msg) Write-Host "X $Msg" -ForegroundColor Red }
function Write-Ok { param([string]$Msg) Write-Host "‚úì $Msg" -ForegroundColor Green }

function Get-Today { return (Get-Date -Format "yyyy-MM-dd") }
function Get-FutureDate { param([int]$Days = 7); return (Get-Date).AddDays($Days).ToString("yyyy-MM-dd") }

function Invoke-GH {
    param([string[]]$Args)
    Write-Debug "gh $($Args -join ' ')"
    try {
        $output = gh @Args 2>&1
        if ($LASTEXITCODE -ne 0) { throw "Exit code $LASTEXITCODE" }
        return $output
    } catch {
        Write-Err "Command failed: gh $($Args -join ' ')"
        throw
    }
}

# ============ COMMANDS ============

function Start-Scan {
    Write-Host "Scanning work..." -ForegroundColor Cyan
    Invoke-GH @("issue", "list", "--repo", $REPO, "--state", "open", "--json", "number,title,labels", "--limit", "20")
    
    if (![string]::IsNullOrWhiteSpace($PROJECT_NUMBER)) {
        Write-Host ""
        try { gh project item-list $PROJECT_NUMBER --owner $REPO_OWNER --format json --limit 20 2>$null }
        catch { }
    }
}

function Complete-Scan {
    Write-Host "Ready for completion..." -ForegroundColor Cyan
    Invoke-GH @("issue", "list", "--repo", $REPO, "--state", "open", "--json", "number,title", "--limit", "20")
    Write-Host ""
    Write-Host "Today: $(Get-Today)"
    Write-Host 'Close with: .\scripts\smart-ops.ps1 close [number]' -ForegroundColor Gray
}

function New-Issue {
    param(
        [string]$Title,
        [string]$Body = "",
        [string]$Labels = "enhancement",
        [int]$Days = 7
    )
    
    if ([string]::IsNullOrWhiteSpace($Title)) {
        Write-Err "Title required"
        return
    }
    
    Write-Host "Creating: $Title (${Days}d)" -ForegroundColor Cyan
    
    $url = Invoke-GH @("issue", "create", "--repo", $REPO, "--title", $Title, "--body", $Body, "--label", $Labels)
    
    if ($url -match '/(\d+)$') {
        $num = $Matches[1]
        Write-Ok "Created #$num"
        
        if (![string]::IsNullOrWhiteSpace($PROJECT_ID)) {
            try {
                $itemId = gh project item-add $PROJECT_NUMBER --owner $REPO_OWNER --url $url --jq '.id'
                
                if (![string]::IsNullOrWhiteSpace($START_DATE_FIELD_ID)) {
                    gh project item-edit --id $itemId --project-id $PROJECT_ID --field-id $START_DATE_FIELD_ID --date (Get-Today) 2>$null
                }
                if (![string]::IsNullOrWhiteSpace($TARGET_DATE_FIELD_ID)) {
                    gh project item-edit --id $itemId --project-id $PROJECT_ID --field-id $TARGET_DATE_FIELD_ID --date (Get-FutureDate -Days $Days) 2>$null
                }
                Write-Ok "Added to project"
            } catch {
                Write-Err "Failed to add to project"
            }
        }
        Write-Host $url
    }
}

function Close-Issue {
    param([string]$Num, [string]$Comment = "Completed")
    
    if ([string]::IsNullOrWhiteSpace($Num)) {
        Write-Err "Issue number required"
        return
    }
    
    $confirm = Read-Host "Close #${Num}? (y/N)"
    if ($confirm -ne 'y') { return }
    
    Invoke-GH @("issue", "close", $Num, "--repo", $REPO, "--comment", $Comment)
    Write-Ok "Closed #$Num"
}

function Move-ToProgress {
    param([string]$Id)
    
    if ([string]::IsNullOrWhiteSpace($PROJECT_ID)) {
        Write-Err "No project configured"
        return
    }
    if ([string]::IsNullOrWhiteSpace($Id)) {
        Write-Err "Item ID required"
        return
    }
    
    gh project item-edit --id $Id --field-id $STATUS_FIELD_ID --project-id $PROJECT_ID --single-select-option-id $IN_PROGRESS_OPTION_ID
    
    if (![string]::IsNullOrWhiteSpace($START_DATE_FIELD_ID)) {
        gh project item-edit --id $Id --project-id $PROJECT_ID --field-id $START_DATE_FIELD_ID --date (Get-Today) 2>$null
    }
    Write-Ok "-> In Progress"
}

function Move-ToDone {
    param([string]$Id)
    
    if ([string]::IsNullOrWhiteSpace($PROJECT_ID)) {
        Write-Err "No project configured"
        return
    }
    if ([string]::IsNullOrWhiteSpace($Id)) {
        Write-Err "Item ID required"
        return
    }
    
    gh project item-edit --id $Id --field-id $STATUS_FIELD_ID --project-id $PROJECT_ID --single-select-option-id $DONE_OPTION_ID
    Write-Ok "-> Done"
}

function Show-Help {
    Write-Host @'
Smart Ops - GitHub Automation

Usage: .\scripts\smart-ops.ps1 [command] [args]

Commands:
  start                      List open issues
  complete                   List for completion
  create [title] [body] [labels] [days]
  close [number] [comment]
  progress [item_id]         Move to In Progress
  done [item_id]             Move to Done

Examples:
  .\scripts\smart-ops.ps1 create "Fix bug" "Description" "bug" 3
  .\scripts\smart-ops.ps1 close 42 "Fixed"
  $env:DEBUG=1; .\scripts\smart-ops.ps1 start
'@ -ForegroundColor Cyan
}

# ============ MAIN ============

Test-Prerequisites

$cmd = if ($args.Count -gt 0) { $args[0] } else { "help" }

try {
    switch ($cmd.ToLower()) {
        "start" { Start-Scan }
        "complete" { Complete-Scan }
        "create" { New-Issue -Title $args[1] -Body $args[2] -Labels $args[3] -Days ([int]$args[4]) }
        "close" { Close-Issue -Num $args[1] -Comment $args[2] }
        "progress" { Move-ToProgress -Id $args[1] }
        "done" { Move-ToDone -Id $args[1] }
        default { Show-Help }
    }
} catch {
    Write-Host ""
    Write-Err "Failed: $_"
    exit 1
}
```

---

## 6. Create Helper Workflows

**File:** `.agent/workflows/smart_start.md`

```markdown
---
description: Start new work with automatic script selection
---
# Workflow: Smart Start

## Usage
User: "/smart_start I want to work on [description]"

## Steps

### 1. Detect Available Script
Check which script exists:
- If `scripts/smart-ops.ps1` exists ‚Üí Use PowerShell
- If `scripts/smart-ops.sh` exists ‚Üí Use Bash
- If both exist ‚Üí Ask user preference or auto-detect shell

### 2. Scan Work
**PowerShell:**
```powershell
.\scripts\smart-ops.ps1 start
```

**Bash:**
```bash
./scripts/smart-ops.sh start
```

### 3. Analyze User Intent
Match description to existing issue OR create new.

### 4. Create Issue
**PowerShell:**
```powershell
.\scripts\smart-ops.ps1 create "Title" "Body" "labels" [days]
```

**Bash:**
```bash
./scripts/smart-ops.sh create "Title" "Body" "labels" [days]
```

### 5. Confirm
Report: Issue #XX, Start: YYYY-MM-DD, Target: YYYY-MM-DD
```

**File:** `.agent/workflows/smart_complete.md`

```markdown
---
description: Complete work with automatic script selection
---
# Workflow: Smart Complete

## Usage
User: "/smart_complete I finished [description]"

## Steps

### 1. Scan Completion Candidates
**PowerShell:**
```powershell
.\scripts\smart-ops.ps1 complete
```

**Bash:**
```bash
./scripts/smart-ops.sh complete
```

### 2. Match Work
Find corresponding issue from description.

### 3. Close Issue
**PowerShell:**
```powershell
.\scripts\smart-ops.ps1 close [number] "Completed in X days"
```

**Bash:**
```bash
./scripts/smart-ops.sh close [number] "Completed in X days"
```

### 4. Calculate Duration
Report: Started YYYY-MM-DD, Completed YYYY-MM-DD (X days)
```

---

## 7. Post-Generation Summary

After creating scripts, tell user:

```
‚úÖ Smart Ops initialized!

üìÅ Created:
   - scripts/smart-ops.ps1   (PowerShell)
   - scripts/smart-ops.sh    (Git Bash/WSL)
   - .agent/workflows/smart_start.md
   - .agent/workflows/smart_complete.md

üöÄ Quick Start:
   PowerShell:  .\scripts\smart-ops.ps1 start
   Git Bash:    ./scripts/smart-ops.sh start

üìñ Available Commands:
   start      - List open issues
   complete   - List for completion
   create     - Create new issue
   close      - Close issue
   progress   - Move to In Progress
   done       - Move to Done

üí° Next Steps:
   1. Run 'start' to see your current work
   2. Use /smart_start to begin new tasks
   3. Use /smart_complete when done
```

---

## Platform Quick Reference

| Environment | Command |
|-------------|---------|
| **Windows PowerShell** | `.\scripts\smart-ops.ps1` |
| **Windows Git Bash** | `./scripts/smart-ops.sh` |
| **WSL** | `./scripts/smart-ops.sh` |
| **macOS Terminal** | `./scripts/smart-ops.sh` |
| **Linux** | `./scripts/smart-ops.sh` |

---

## Troubleshooting

**"uname not found" in PowerShell:**
‚úÖ Normal! Use the `.ps1` script in PowerShell.

**Both scripts exist, which one to use?**
- PowerShell? ‚Üí Use `.ps1`
- Git Bash/WSL? ‚Üí Use `.sh`

**Scripts not found:**
Run `/init_smart_ops` again to regenerate.